<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, user-scalable=0"/>
    <title>WASM UEFIPatch</title>
    <style>
      html, body { padding: 0; margin: 0; overflow:hidden; height: 100vh; background-color: black; color:#00ff00; font-family: monospace; }
      canvas { border: 0px none; background-color: black; height:100%; width:100%;  }
      canvas { outline: 0px solid transparent; caret-color: transparent; cursor:default }
      #file-inputs { position: absolute; top: 10px; left: 10px; }
      textarea { width: 100%; box-sizing: border-box; }
    </style>
  </head>
  <body onload="init()">
    <div id="file-inputs">
      <h1>WASM UEFIPatch</h1>
      <h2>UEFI firmware patcher</h2>
      <h3>Select your rom files and optionally supply your own patches.</h3>
      <!-- <h3>Buggy handling of multiple patches only works reliably on the first patch.</h3> -->
      <h3>Disable Secure Boot: Patch out secure boot on AMD AMI firmwares by replacing all EFI_SECURITY_VIOLATION with EFI_SUCCESS in SecurityStubDxe</h3>
      <h3>Uses <a href="https://github.com/LongSoft/UEFITool/blob/old_engine/UEFIPatch/" target="_blank">UEFIPatch</a> under the hood. See <a href="https://github.com/LongSoft/UEFITool/blob/old_engine/UEFIPatch/patches.txt" target="_blank">this</a> for patch format.</h3>
      <input type="file" id="input-rom" accept=".rom">
      <br>
      <div id="patches-selector">
        <!-- Checkbox for disable secure boot. -->
        <div id="preset-patches">
          <input type="checkbox" data-patchname="DSB">Disable Secure Boot (only tested on AMD AMI firmwares).</input>
        </div>
        <input type="checkbox" data-patchname="custom">Custom</input>
        <textarea id="custom-patch" oninput='this.style.height = "";this.style.height = this.scrollHeight + "px"' data-patchname="custom" placeholder="Enter custom patches here"></textarea>
      </div>
      <h3>Resultant patches.txt</h3>
      <p>The below text will be pumped verbatim into UEFIPatch.</p>
      <pre id="patches-txt"></pre>
      <br>
      <button id="run-patch">Patch</button>
      <h3>Output (only updates on completion)</h3>
      <pre id="output"></pre>
    </div>
    <figure style="overflow:visible;" id="qtspinner">
      <center style="margin-top:1.5em; line-height:150%">
        <strong>WASM UEFIPatch</strong>
        <div id="qtstatus"></div>
        <noscript>JavaScript is disabled. Please enable JavaScript + WASM to use this application.</noscript>
      </center>
    </figure>
    <canvas id="qtcanvas" oncontextmenu="event.preventDefault()" contenteditable="true"></canvas>

    <script type='text/javascript'>
        function init() {
          var spinner = document.querySelector('#qtspinner');
          var canvas = document.querySelector('#qtcanvas');
          var status = document.querySelector('#qtstatus');

          var qtLoader = QtLoader({
              canvasElements : [canvas],
              showLoader: function(loaderStatus) {
                  spinner.style.display = 'block';
                  canvas.style.display = 'none';
                  status.innerHTML = loaderStatus + "...";
              },
              showError: function(errorText) {
                  status.innerHTML = errorText;
                  spinner.style.display = 'block';
                  canvas.style.display = 'none';
              },
              showExit: function() {
                  status.innerHTML = "Application exit";
                  if (qtLoader.exitCode !== undefined)
                      status.innerHTML += " with code " + qtLoader.exitCode;
                  if (qtLoader.exitText !== undefined)
                      status.innerHTML += " (" + qtLoader.exitText + ")";
                  spinner.style.display = 'block';
                  canvas.style.display = 'none';
              },
              // showCanvas: function() {
              //     spinner.style.display = 'none';
              //     canvas.style.display = 'block';
              // },
          });
          qtLoader.loadEmscriptenModule("UEFIPatch");

          document.getElementById('run-patch').addEventListener('click', function() {
              //reset the log
              document.getElementById('output').innerText = '';
              //get the input rom file
              var inputRom = document.getElementById('input-rom').files[0];
              var patchesTxt = document.getElementById('patches-txt').innerText;
              //print the type of patchesTxt
              console.log(patchesTxt);

              if (inputRom) {
                  var reader = new FileReader();
                  reader.onload = function(e) {
                      var inputRomArray = new Uint8Array(e.target.result);
                      FS.writeFile("INPUT.ROM", inputRomArray);
                      FS.writeFile("patches.txt", patchesTxt);
                      Module.ccall('runPatch', null, [], []);
                  };
                  reader.readAsArrayBuffer(inputRom);
              } else {
                  alert('Please select an INPUT.ROM file.');
              }
          });
          //when any checkbox is clicked, update the preview for patches.txt
          document.getElementById('patches-selector').addEventListener('click', function(e) {
            if (e.target.type === 'checkbox') {
              refreshPatches()
            }
          });
        }
        function refreshPatches() {
          //PATCHLIST
          var patchMapping = {
            'DSB': "# Replace EFI_SECURITY_VIOLATION with EFI_SUCCESS in SecurityStubDxe \n\
F80697E9-7FD6-4665-8646-88E33EF71DFC 10 P:1A00000000000080:0000000000000000\n",
            'custom': document.querySelector('textarea[data-patchname="custom"]').value
          };
          var patchesTxt = '';
          //loop through all the checkboxes with data-patchname, and add the corresponding patch to patchesTxt
          //patch name is a variable that is the same as the data-patchname attribute
          //so we can use it to avoid hardcoding the patch names in our loop.
          var checkboxes = document.querySelectorAll('input[type="checkbox"]');
          for (var i = 0; i < checkboxes.length; i++) {
            var patchName = checkboxes[i].getAttribute('data-patchname');
            if (checkboxes[i].checked && patchMapping[patchName]) {
              patchesTxt += patchMapping[patchName];
            }
          }
          document.getElementById('patches-txt').innerText = patchesTxt;
        }
        document.addEventListener('DOMContentLoaded', function() {
            refreshPatches();
        });
    </script>
    <script type="text/javascript" src="qtloader_mod.js"></script>
  </body>
</html>
